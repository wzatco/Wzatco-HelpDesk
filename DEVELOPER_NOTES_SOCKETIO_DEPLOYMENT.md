# üö® CRITICAL: Socket.IO Deployment Issue on Hostinger Cloud

## Problem Summary
Our Next.js 15 application uses a **custom Node.js server (`server.js`)** to run Socket.IO for real-time features. However, Hostinger's deployment system was running the **default Next.js standalone server** instead, causing Socket.IO endpoints to return 404 errors.

---

## Root Cause Analysis

### Issue 1: Next.js Standalone Build Overwrites Custom Server
When running `next build`, Next.js creates a **standalone deployment** at `.next/standalone/server.js` that contains its own server implementation. This auto-generated file **does not include our Socket.IO initialization**.

**Location of the problem:**
```
.next/standalone/server.js  ‚Üê Generated by Next.js (no Socket.IO)
server.js                   ‚Üê Our custom server (with Socket.IO)
```

### Issue 2: Hostinger Deployment Configuration
Hostinger uses **Passenger** (Phusion Passenger) as the application server, configured via `.htaccess`:

```apache
PassengerStartupFile server.js
```

However, Hostinger's build process was deploying the **standalone build directory**, where `server.js` was the Next.js-generated version, not our custom one.

### Issue 3: Static File Serving
The Next.js standalone build requires specific configuration to serve static assets (`_buildManifest.js`, `_ssgManifest.js`, etc.) from the `.next/static/` directory.

---

## Our Solution

### 1. Postbuild Script to Replace Server
We added a `postbuild` script in `package.json` that automatically replaces the Next.js standalone server with our custom Socket.IO server after each build:

```json
"scripts": {
  "build": "prisma generate && next build && npm run postbuild",
  "postbuild": "node -e \"const fs=require('fs'); const path=require('path'); if(fs.existsSync('.next/standalone')){const customServer=path.join(process.cwd(),'server.js'); const standaloneServer=path.join('.next','standalone','server.js'); if(fs.existsSync(standaloneServer)){fs.copyFileSync(standaloneServer,standaloneServer+'.nextjs-backup'); console.log('‚úÖ Backed up Next.js standalone server');} fs.copyFileSync(customServer,standaloneServer); console.log('‚úÖ Replaced with custom Socket.IO server'); console.log('üìÇ Location:',standaloneServer);}\"",
  "start": "node server.js"
}
```

**What it does:**
1. Backs up the Next.js standalone server to `.next/standalone/server.js.nextjs-backup`
2. Copies our custom `server.js` to `.next/standalone/server.js`
3. Logs confirmation to build output

### 2. Updated .htaccess Configuration
We created a comprehensive `.htaccess` file for Hostinger that:
- Configures Passenger to use Node.js 20
- Sets the startup file to `server.js`
- Adds rewrite rules to serve Next.js static files
- Grants access to the `.next` directory

```apache
# Hostinger Next.js + Socket.IO Configuration
PassengerAppType node
PassengerNodejs /opt/alt/alt-nodejs20/root/bin/node
PassengerStartupFile server.js
PassengerBaseURI /
PassengerAppEnv production

# Enable static file serving
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /
  
  # Serve Next.js static files from .next/static
  RewriteCond %{REQUEST_URI} ^/_next/static/
  RewriteCond %{DOCUMENT_ROOT}/.next/static/%{REQUEST_URI} -f
  RewriteRule ^_next/static/(.*)$ /.next/static/$1 [L]
  
  # Serve public files
  RewriteCond %{REQUEST_URI} !^/api/
  RewriteCond %{DOCUMENT_ROOT}%{REQUEST_URI} -f
  RewriteRule ^ - [L]
</IfModule>
```

### 3. Procfile for Process Management
Added a `Procfile` to explicitly define the startup command:

```
web: NODE_ENV=production node server.js
release: prisma generate && prisma migrate deploy
```

---

## Custom Server Architecture

### Our `server.js` Implementation
Our custom server integrates:
1. **Next.js request handler** - For page rendering and API routes
2. **Socket.IO** - For real-time WebSocket connections
3. **HTTP server** - Single server instance for both

**Key features:**
```javascript
// Initialize Socket.IO with custom path
const io = new Server(httpServer, {
  path: '/api/widget/socket',
  cors: { /* ... */ },
  transports: ['polling', 'websocket'],
  allowUpgrades: true
});

// Socket.IO handles its own routes
if (parsedUrl.pathname.startsWith('/api/widget/socket') || 
    parsedUrl.pathname.startsWith('/socket.io/')) {
  return; // Let Socket.IO handle
}

// Everything else goes to Next.js
handle(req, res, parsedUrl);
```

---

## Deployment Checklist for Hostinger

### ‚úÖ Repository Configuration
- [x] Custom `server.js` in repository root
- [x] `postbuild` script in `package.json`
- [x] `.htaccess` configured for Passenger + static files
- [x] `Procfile` with start command
- [x] `.env.production` with correct domain URLs

### ‚úÖ Hostinger Dashboard Settings
- [ ] Build Command: `npm install && npm run build`
- [ ] Start Command: `node server.js`
- [ ] Node.js Version: 20.x or higher
- [ ] Environment Variables:
  - `NEXTAUTH_URL=https://your-domain.hostingersite.com`
  - `NEXT_PUBLIC_BASE_URL=https://your-domain.hostingersite.com`
  - `CLIENT_URL=https://your-domain.hostingersite.com`
  - `NODE_ENV=production`
  - (Plus database, JWT secrets, etc.)

### ‚úÖ Post-Deployment Verification
Check browser console for:
- ‚úÖ No 404 errors on `/api/widget/socket/?EIO=4&transport=polling`
- ‚úÖ No 404 errors on `_buildManifest.js` or `_ssgManifest.js`
- ‚úÖ Socket.IO connection established logs
- ‚úÖ Widget functionality working

---

## Build Logs - What to Look For

### ‚úÖ Successful Build Output
```
> adminnagent@0.1.0 postbuild
‚úÖ Backed up Next.js standalone server
‚úÖ Replaced with custom Socket.IO server
üìÇ Location: .next/standalone/server.js
```

### ‚ùå Common Issues

**Issue:** Socket.IO 404 errors
```
GET /api/widget/socket/?EIO=4&transport=polling 404
```
**Cause:** Hostinger is running `next start` instead of `node server.js`  
**Solution:** Verify start command in Hostinger dashboard

**Issue:** Static file 404 errors
```
GET /_next/static/build-xxx/_buildManifest.js 404
```
**Cause:** `.htaccess` rewrite rules missing or incorrect  
**Solution:** Update `.htaccess` with static file serving rules

---

## Why This Approach?

### Alternative Approaches We Considered:

1. **API Routes for WebSocket** ‚ùå
   - Next.js API routes are serverless functions
   - Cannot maintain persistent WebSocket connections
   - Would require external service (Pusher, Ably)

2. **Separate Socket.IO Server** ‚ùå
   - Adds deployment complexity
   - Requires CORS configuration
   - Extra infrastructure cost

3. **Custom Server (Our Choice)** ‚úÖ
   - Single deployment artifact
   - Native Socket.IO integration
   - Full control over server lifecycle
   - Cost-effective

---

## Technical References

- **Next.js Custom Server Docs:** https://nextjs.org/docs/pages/building-your-application/configuring/custom-server
- **Socket.IO with Next.js:** https://socket.io/how-to/use-with-nextjs
- **Passenger Configuration:** https://www.phusionpassenger.com/docs/advanced_guides/config_and_optimization/nodejs/
- **Hostinger Node.js Deployment:** https://support.hostinger.com/en/articles/how-to-deploy-a-nodejs-website-in-hostinger

---

## Key Commits

1. `fe50c7b` - Fix: correctly replace Next.js standalone server with custom Socket.IO server
2. `d64a484` - Feat: configure for new Hostinger deployment (lightblue-lion-382226)
3. `2b16fb7` - Feat: add complete .htaccess configuration for static file serving

---

## Contact & Support

If you encounter issues:
1. Check Hostinger application logs for startup errors
2. Verify environment variables are set correctly
3. Ensure `.htaccess` is in `/public_html/` directory
4. Create `restart.txt` in `/public_html/` to force Passenger restart

---

**Author:** AI Assistant  
**Date:** January 3, 2026  
**Project:** Wzatco Help Desk  
**Repository:** https://github.com/wzatco/Wzatco-HelpDesk

